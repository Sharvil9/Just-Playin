<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p5.js Audio Visualizer Kaleidoscope</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <style>
        /* Basic CSS for layout */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            background-color: #1a1a1a; /* Slightly lighter dark background */
            font-family: sans-serif;
            color: #eee;
            overflow: hidden; /* Prevent scrollbars */
        }
        /* Container for p5 canvas to help with layout */
        #canvas-container {
            margin-bottom: 20px; /* Space below canvas */
            width: 80%; /* Match canvas width percentage */
            height: 70vh; /* Match canvas height percentage */
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #444; /* Slightly lighter border */
            position: relative; /* Needed for positioning status text */
            cursor: pointer; /* Indicate canvas is clickable */
        }
        canvas {
            display: block; /* Remove extra space below canvas */
            max-width: 100%;
            max-height: 100%;
        }
        /* Styling for controls */
        .controls {
            display: flex;
            flex-wrap: wrap; /* Allow controls to wrap on smaller screens */
            justify-content: center;
            align-items: center;
            gap: 15px; /* Space between control elements */
            padding: 10px;
            background-color: #333; /* Background for controls area */
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Subtle shadow */
        }
        label {
            margin-right: 5px;
        }
        input[type="range"] {
            cursor: pointer;
        }
        button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            background-color: #555;
            color: #eee;
            border: none;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #777;
        }
        /* Status message styling */
        #status-message {
            position: absolute; /* Position over the canvas */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            background-color: rgba(0, 0, 0, 0.7); /* Slightly darker background */
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            z-index: 10; /* Ensure it's above the canvas drawing */
            display: none; /* Hidden by default, shown via JS */
            pointer-events: none; /* Allow clicks to pass through to canvas */
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div id="status-message">Click canvas to start audio</div>
    </div>

    <div class="controls">
        <div>
            <label for="sensitivity">Sensitivity:</label>
            <input type="range" id="sensitivity" min="0.1" max="5" value="1" step="0.1">
        </div>
        <button id="toggle-bg">Toggle Background</button>
    </div>

    <script>
        let mic; // p5.AudioIn object - Will be initialized later
        let amplitude; // Amplitude analyzer
        let sensitivitySlider;
        let toggleBgButton;
        let statusMessage; // To display messages
        let cnv; // To hold the canvas element for attaching listener

        const numSegments = 6; // Kaleidoscope segments
        let isTransparentBg = false; // State for background mode
        let audioStarted = false; // Flag to track if audio context is running

        function setup() {
            // Create canvas and parent it to the container div
            let canvasContainer = select('#canvas-container');
            cnv = createCanvas(canvasContainer.width, canvasContainer.height);
            cnv.parent('canvas-container'); // Attach canvas to the specific div

            // Attach the mousePressed listener directly to the canvas element
            cnv.mousePressed(startAudio);

            // Get control elements
            sensitivitySlider = select('#sensitivity');
            toggleBgButton = select('#toggle-bg');
            statusMessage = select('#status-message');

            // Set initial status message visibility
            statusMessage.style('display', 'block');

            // Add event listener for the background toggle button
            toggleBgButton.mousePressed(toggleBackground);

            // Set p5.js modes
            colorMode(HSB, 360, 100, 100, 1);
            angleMode(DEGREES);

            // Initialize Amplitude Analyzer (but don't connect input yet)
            amplitude = new p5.Amplitude();

            // Initial background draw
            drawInitialBackground();

            // --- Mic is NOT initialized here anymore ---

            console.log("Setup complete. Visualizer active with default animation. Click canvas to enable microphone.");
        }

        function draw() {
            // --- Background ---
            if (isTransparentBg) {
                clear(); // Fully transparent background, no trails
            } else {
                background(10, 0.1); // Dark, semi-transparent for fading trails
            }

            // --- Get Level ---
            let level = 0; // Default level
            if (audioStarted && mic) {
                // Get actual audio level if mic is active
                level = amplitude.getLevel();
            } else {
                // Generate a gentle oscillating value for default animation
                // Use frameCount for a time-based oscillation
                let time = frameCount * 0.5; // Slow down the oscillation
                level = map(sin(time), -1, 1, 0.01, 0.05); // Map sine wave (-1 to 1) to a small level range (e.g., 0.01 to 0.05)
            }

            // --- Apply Sensitivity ---
            let sensitivity = sensitivitySlider.value();
            let adjustedLevel = level * sensitivity;

            // --- Map to Visuals ---
            // Adjust mapping slightly for the default animation to be visible
            let minInputLevel = audioStarted ? 0 : 0.01; // Base level differs if audio is active or not
            let maxInputLevel = audioStarted ? 0.5 : 0.1; // Max expected level differs

            let strokeWeightValue = constrain(map(adjustedLevel, minInputLevel, maxInputLevel, 1, 50), 1, 50);
            let hueValue = map(level, 0, 0.5, 180, 360); // Hue mapping remains the same
            let brightnessValue = constrain(map(adjustedLevel, minInputLevel, maxInputLevel, 50, 100), 50, 100);

            // --- Draw ---
            strokeWeight(strokeWeightValue);
            stroke(hueValue, 90, brightnessValue, 0.8);
            noFill();

            translate(width / 2, height / 2);
            let angleIncrement = 360 / numSegments;

            for (let i = 0; i < numSegments; i++) {
                rotate(angleIncrement);
                // Adjust line length mapping too
                let lineLength = constrain(map(adjustedLevel, minInputLevel, maxInputLevel, 5, min(width, height) * 0.4), 5, min(width, height) * 0.4);
                line(strokeWeightValue, strokeWeightValue, lineLength, lineLength);

                push();
                scale(1, -1); // Mirror
                line(strokeWeightValue, strokeWeightValue, lineLength, lineLength);
                pop();
            }
        }

        // Function to attempt starting audio context and mic input
        function startAudio() {
            // Prevent multiple attempts or starting if already running
            if (audioStarted) {
                console.log("Audio already started.");
                return;
            }
            // Prevent attempts if mic initialization is already in progress (optional safety)
            if (window.audioStarting) return;
            window.audioStarting = true; // Set a flag

            console.log("Canvas clicked. Attempting to start audio...");
            statusMessage.html('Initializing Audio...');
            statusMessage.style('display', 'block'); // Make sure it's visible

            // userStartAudio() initializes the audio context on user gesture
            userStartAudio().then(() => {
                console.log("Audio context started successfully.");
                statusMessage.html('Starting Microphone...');

                // --- Initialize AudioIn AFTER context is running ---
                mic = new p5.AudioIn();

                // Start the microphone
                mic.start(() => {
                    console.log("Microphone started successfully.");
                    // Connect mic to the amplitude analyzer
                    amplitude.setInput(mic);
                    audioStarted = true; // Set flag
                    statusMessage.style('display', 'none'); // Hide status message
                    window.audioStarting = false; // Clear flag
                    // Draw the active background immediately
                    if (isTransparentBg) clear(); else background(10);
                }, (err) => {
                    // Error starting mic specifically
                    console.error("Mic start error:", err);
                    statusMessage.html('Error starting microphone. Check permissions & refresh.');
                    statusMessage.style('display', 'block');
                    audioStarted = false;
                    window.audioStarting = false; // Clear flag
                });
            }).catch((e) => {
                // Error starting the base audio context
                console.error("UserStartAudio error:", e);
                statusMessage.html('Audio Error: Could not start. Check browser permissions & refresh.');
                statusMessage.style('display', 'block');
                audioStarted = false;
                window.audioStarting = false; // Clear flag
            });
        }

        // Function to toggle background mode
        function toggleBackground() {
            isTransparentBg = !isTransparentBg;
            console.log("Background toggled. Transparent:", isTransparentBg);
            toggleBgButton.html(isTransparentBg ? 'Use Dark Background' : 'Use Transparent BG');
            // Apply background change immediately
             if (isTransparentBg) {
                clear();
             } else {
                // If switching to dark, draw solid dark bg once, draw loop will handle fading
                background(10);
             }
        }

        // Draw the initial background (solid color)
        function drawInitialBackground() {
             if (isTransparentBg) {
                 clear();
             } else {
                 background(10); // Solid dark grey background initially
             }
        }

        // Adjust canvas size when the window is resized
        function windowResized() {
            let canvasContainer = select('#canvas-container');
            // Use container's dimensions for canvas size
            // Check if container has valid dimensions before resizing
            if (canvasContainer.width > 0 && canvasContainer.height > 0) {
                 resizeCanvas(canvasContainer.width, canvasContainer.height);
                 console.log("Window resized, canvas adjusted.");
                 // Redraw the appropriate background/state
                 if (isTransparentBg) clear(); else background(10);
            } else {
                 console.warn("Window resized, but container has zero dimensions. Canvas not resized.");
            }
        }

    </script>
</body>
</html>
